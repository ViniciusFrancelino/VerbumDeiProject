<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/VerbumDei-SemFundo-Invert.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VerbumDei | Dashboard</title>

    <!--ChartJs-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="./../css/dashboards.css">

    <script src="../js/sessao.js"></script>
    <script src="../js/alerta.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
</head>

<body onload="validarSessao(),  atualizacaoPeriodica()">

    <div class="divOptionSide">
        <div class="divOptionLogo">
            <img src="../assets/imgs/logo-Invert.png" alt="Logo VerbumDei Invertido">
        </div>

        <div class="hello">
            <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
        </div>

        <div class="divOptionButton">
            <a href="dashboard.html">
                <h3>Dashboard</h3>
            </a>
        </div>

        <div class="divOptionButton">
            <a href="biblia.html">
                <h3>Biblia</h3>
            </a>
        </div>

        <div class="divOptionButton">
            <a href="quiz.html">
                <h3>Quiz</h3>
            </a>
        </div>

        <div class="divOptionButton">
            <a href="mural.html">
                <h3>Fórum</h3>
            </a>
        </div>

        <div class="divOptionLogout" onclick="limparSessao()">
            <h3>Sair</h3>
        </div>
    </div>

    <div class="divKpiGerais">
        <span>Publicações: <span id="idPublicacoes"></span></span>
        <span>Tentativas Quiz: <span id="idTentativas"></span></span>
        <span>Acertos: <span id="idAcertos"></span></span>
    </div>

    <div class="divGraficosGerais">
        <div class="divGrafico1">
            <canvas id="myChart1"></canvas>
            <canvas id="myChart2"></canvas>
        </div>
    </div>

</body>

</html>

<script>

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    const firtsGraf = document.getElementById('myChart1');
    let proximaAtualizacao;

    window.onload = obterDados();

    function obterDados() {

        var idUsuario = sessionStorage.ID_USUARIO;
        
        // Obter dados para KPIs da dashboard
        fetch(`/dash/dash/${idUsuario}`, { cache: 'no-store' })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log("KPI recebida:", resposta);
                        plotarKpi(resposta); 
                    });
                } else {
                    console.error('Nenhum dado encontrado');
                }
            })
            .catch(function (erro) {
                console.error(`Erro ao Obter KPIs: ${error.message}`);
            
            });


        // fetch(`/dashboard/graficos/${idUsuario}`, { cache: 'no-store' })
        //     .then(function (response) {
        //         if (response.ok) {
        //             response.json().then(function (resposta) {
        //                 conosle.log(`Dados Recebidos:`, resposta);
        //                 resposta.reverse();

        //                 plotarGrafico(resposta, idUsuario);
        //             });
        //         } else {
        //             console.log("Nenhum Dado Encontrado!");
        //         }
        //     })
        //     .catch(function (error) {
        //         console.error(`Erro na Obtenção de dados do Grafico: ${error.message}`);
        //     })
    }

    function plotarGrafico(resposta, idUsuario) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Umidade',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            },
            {
                label: 'Temperatura',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.umidade);
            dados.datasets[1].data.push(registro.temperatura);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChartCanvas${idUsuario}`),
            config
        );

        setTimeout(() => atualizarGrafico(idUsuario, dados, myChart), 2000);
    }

    function plotarGrafico(resposta) {

        let labels = [];
        let respCerta = [];

        for (let i = 0; i < resposta.length; i++) {

            let registro = resposta[i];
            labels.push(registro.data_resposta);
            respCerta.push(registro.Respostas_certa);
        }


        // Confs Graficos
        const config = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Certas',
                        data: resCertas,
                        backgroundColor: [
                            'rgb(72, 202, 89)'
                        ]
                    },
                    {
                        label: 'Erradas',
                        data: resErradas,
                        backgroundColor: [
                            'rgb(227, 76, 76)'
                        ]
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMax: 5
                    }
                }
            }
        };

        while (labels.length > 5) {
            labels.shift();
            respCertas.shift()
        }

        // Gerando novo gráfico
        window.graficoAtual = new Chart(canvasGraf, config);
    }

    function plotarKpis(resposta) {

        idPublicacoes.innerHTML = `${resposta[0].publicaoesMural}`;
        idTentativas.innerHTML = `${resposta[0].TentativasRealizadas}%`;
        idAcertos.innerHTML = `${resposta[0].AcertosGerais}`;

        console.log("KPIs recebidas da API:", resposta);
    }

</script>